# Docker Compose for YouTube Analyzer
#
# Usage:
#   Local development:     docker-compose up local
#   HTTP server mode:      docker-compose up server

services:
  # Local development - interactive mode
  local:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: youtube-analyzer-local
    stdin_open: true
    tty: true
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_DEFAULT_CHANNEL=${SLACK_DEFAULT_CHANNEL:-#youtube-summaries}
      - NOTES_BACKEND=local
      - NOTES_LOCAL_DIR=/app/notes
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./notes:/app/notes
      - ./.env:/app/.env:ro
    command: python run_local.py

  # Run a single video analysis
  analyze:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: youtube-analyzer-single
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - NOTES_BACKEND=local
      - NOTES_LOCAL_DIR=/app/notes
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./notes:/app/notes
    command: python agent.py "${VIDEO_URL:-https://www.youtube.com/watch?v=dQw4w9WgXcQ}"

  # HTTP server mode (FastAPI)
  server:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: youtube-analyzer-server
    ports:
      - "8080:8080"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - NOTES_BACKEND=local
      - NOTES_LOCAL_DIR=/app/notes
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./notes:/app/notes
    command: python server.py

  # RAG Chatbot
  chatbot:
    build:
      context: .
      dockerfile: Dockerfile.chatbot
    container_name: youtube-chatbot
    ports:
      - "8081:8081"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CHATBOT_MODEL_ID=${CHATBOT_MODEL_ID:-claude-sonnet-4-5-20250514}
      - KB_MAX_RESULTS=${KB_MAX_RESULTS:-5}
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    command: python chatbot_server.py

  # Local transcript fetcher (runs on cron)
  fetcher:
    build:
      context: .
      dockerfile: Dockerfile.fetcher
    container_name: youtube-fetcher
    environment:
      - MONITOR_CHANNEL_URLS=${MONITOR_CHANNEL_URLS}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - NOTES_BACKEND=local
      - NOTES_LOCAL_DIR=/app/notes
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./notes:/app/notes
      - fetcher-logs:/var/log
    restart: unless-stopped

  # Cloudflare Tunnel for external access
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped

volumes:
  fetcher-logs:
