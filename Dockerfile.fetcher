# Local transcript fetcher container with cron
#
# This container runs on a local machine to fetch YouTube transcripts
# (avoiding IP blocking) and sends them to Lambda for AI processing.

FROM python:3.11-slim

# Install curl for supercronic download
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install supercronic (cron replacement designed for containers)
# https://github.com/aptible/supercronic
ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.2.29/supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=cd48d45c4b10f3f0bfdd3a57d054cd05ac96812b
RUN curl -fsSLO "$SUPERCRONIC_URL" \
    && echo "${SUPERCRONIC_SHA1SUM}  supercronic-linux-amd64" | sha1sum -c - \
    && chmod +x supercronic-linux-amd64 \
    && mv supercronic-linux-amd64 /usr/local/bin/supercronic

WORKDIR /app

# Copy requirements and install
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY local_fetcher.py .
COPY tools/ ./tools/

# Create crontab file (every 30 minutes)
RUN echo "*/30 * * * * cd /app && python local_fetcher.py >> /var/log/fetcher.log 2>&1" > /app/crontab

# Create log file
RUN touch /var/log/fetcher.log

# Default: run supercronic with our crontab
CMD ["supercronic", "/app/crontab"]
