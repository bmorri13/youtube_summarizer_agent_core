# Deploy to Homelab via Tailscale SSH
#
# Syncs code to home server, generates .env from GitHub Secrets,
# and rebuilds Docker containers.

name: Deploy to Homelab

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:git-ci

      - name: Generate .env on server
        env:
          TS_SSH_HOST: ${{ secrets.TS_SSH_HOST }}
          TS_SSH_USER: ${{ secrets.TS_SSH_USER }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MONITOR_CHANNEL_URLS: ${{ secrets.MONITOR_CHANNEL_URLS }}
        run: |
          # Build .env locally using printf to safely handle special characters
          {
            printf '# Generated by GitHub Actions deploy on %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            printf 'ANTHROPIC_API_KEY=%s\n' "$ANTHROPIC_API_KEY"
            printf 'OPENAI_API_KEY=%s\n' "$OPENAI_API_KEY"
            printf 'SUPABASE_URL=%s\n' "$SUPABASE_URL"
            printf 'SUPABASE_SERVICE_KEY=%s\n' "$SUPABASE_SERVICE_KEY"
            printf 'SLACK_WEBHOOK_URL=%s\n' "$SLACK_WEBHOOK_URL"
            printf 'MONITOR_CHANNEL_URLS=%s\n' "$MONITOR_CHANNEL_URLS"
            printf 'LOG_LEVEL=INFO\n'
          } > /tmp/dotenv

          # Ensure target directory exists and copy .env to server
          ssh -o StrictHostKeyChecking=no ${TS_SSH_USER}@${TS_SSH_HOST} \
            "mkdir -p /opt/docker/youtube-analyzer"
          scp -o StrictHostKeyChecking=no /tmp/dotenv \
            ${TS_SSH_USER}@${TS_SSH_HOST}:/opt/docker/youtube-analyzer/.env
          rm -f /tmp/dotenv

      - name: Deploy to home server
        env:
          TS_SSH_HOST: ${{ secrets.TS_SSH_HOST }}
          TS_SSH_USER: ${{ secrets.TS_SSH_USER }}
        run: |
          # Sync code (exclude git, terraform, node_modules, .env)
          rsync -az --delete \
            --exclude '.git' --exclude 'terraform' --exclude 'node_modules' \
            --exclude 'frontend/node_modules' --exclude '.env' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${TS_SSH_USER}@${TS_SSH_HOST}:/opt/docker/youtube-analyzer/

          # Stop old fetcher deployment if it exists (migrated to youtube-analyzer)
          ssh -o StrictHostKeyChecking=no ${TS_SSH_USER}@${TS_SSH_HOST} "
            if [ -f /opt/docker/yt-transcript/docker-compose.yml ]; then
              cd /opt/docker/yt-transcript && docker compose down || true
            fi
          "

          # Rebuild and restart all services
          ssh -o StrictHostKeyChecking=no ${TS_SSH_USER}@${TS_SSH_HOST} "
            cd /opt/docker/youtube-analyzer && \
            docker compose down && \
            docker compose build && \
            docker compose up -d
          "

      - name: Verify deployment
        env:
          TS_SSH_HOST: ${{ secrets.TS_SSH_HOST }}
          TS_SSH_USER: ${{ secrets.TS_SSH_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no ${TS_SSH_USER}@${TS_SSH_HOST} "
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E 'chatbot|fetcher'
          "

      - name: Summary
        run: |
          echo "## Homelab Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
